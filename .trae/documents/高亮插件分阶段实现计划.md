## 总览
- 按“交付顺序（建议）”分四个阶段推进，每个功能点含目标、设计接口、涉及文件、实施步骤、验收标准与风险回退。
- 严格遵循项目规则：组合式 API + TypeScript、Tailwind 样式隔离（Shadow DOM 与 @scope）、Tampermonkey 最小权限、内存管理与清理。

## 阶段一：基础可配置与安全

### 功能点：匹配选项开关（caseSensitive / wholeWord / regex）
- 目标：为每条规则与本次运行提供可切换的匹配选项，覆盖大小写敏感、全词、正则模式。
- 设计与接口：
  - 规则数据结构新增字段：`matchOptions: { caseSensitive: boolean; wholeWord: boolean; regex: boolean }`（默认：`{ false, false, false }`）。
  - UI 与临时运行开关：在配置面板与导航面板提供选项；调用高亮流程时按选项生成匹配器。
- 触点与文件：
  - `src/views/app/config.ts`（类型与默认值）、`src/views/app/components/ConfigDialog.vue`（UI）
  - `src/views/app/hook.ts`（matchedKeywords 计算与传参）、`src/util/tools.ts`（initHighlighter / highlightKeywords）
- 实施步骤：
  - 扩展类型与默认值；更新校验与表单映射；UI 勾选项与预览；在 `highlightMatchedKeywords` 中根据选项生成关键字集合与匹配器；`highlightKeywords` 接受选项并传入高亮器。
- 验收标准：
  - 三种选项分别对同一页面验证命中差异；配置持久化后重载仍生效；临时开关不污染已保存规则。
- 风险与回退：
  - 正则误伤：提供“测试当前页面”预览；异常时回退为普通包含匹配。

### 功能点：JSON Schema 校验替代手写校验
- 目标：以 Schema 明确规则结构与类型错误位置，提升可维护性与错误提示准确性。
- 设计与接口：
  - 使用轻量 Schema 校验库（体积与 CDN 可用性评估），或内置最小实现；对 `RuleItem[]` 做结构校验与错误聚合。
- 触点与文件：
  - `src/views/app/config.ts`（`validateConfig` 替换/封装）、`src/views/app/components/ConfigDialog.vue`（错误展示）
- 实施步骤：
  - 定义 Schema；封装 `validateConfigBySchema(configList)` 返回详细错误；UI 显示逐项错误位置与原因。
- 验收标准：
  - 故意注入错误（空关键词、非法正则、缺字段）时给出清晰提示；合法配置通过并可保存。
- 风险与回退：
  - 第三方库不可用时保留原手写校验作为兜底。

### 功能点：最小权限对齐（@grant）
- 目标：构建源与产出元数据一致，仅声明实际使用的 GM_* 权限。
- 设计与接口：
  - 对比 `vite.config.ts` 与 `dist/highlight-keywords.user.js` 的 `@grant`；移除未用项，必要时以插件配置约束生成。
- 触点与文件：
  - `vite.config.ts`、`dist/highlight-keywords.user.js`（构建核查）
- 实施步骤：
  - 梳理代码实际调用的 GM_*；更新 `vite.config.ts` 的 `userscript.grant`；确认产出对齐；在调试面板记录当前权限集。
- 验收标准：
  - 构建后元数据只含必要权限；脚本功能正常。
- 风险与回退：
  - 若插件强制注入额外权限，保留说明并在文档与调试面板提示。

## 阶段二：体验与导航

### 功能点：全局快捷键（上一/下一/启用/清除，可启停）
- 目标：键盘高效导航与操作，支持启停与自定义。
- 设计与接口：
  - `settings.shortcut`: `{ enable: boolean; prev: string; next: string; enableHighlight: string; clearHighlight: string }`；在面板提供切换与编辑入口。
- 触点与文件：
  - `src/views/app/index.vue`（注册/卸载）、`src/views/app/components/NavigationPanel.vue`（UI）、`src/views/app/hook.ts`（调用对应处理函数）
- 实施步骤：
  - 在挂载时根据设置注册键盘监听；卸载时清理；冲突时提示并禁用。
- 验收标准：
  - 快捷键触发对应功能；启停与自定义保存并生效。

### 功能点：面板关闭时长可配置
- 目标：关闭面板的时间由用户配置并持久化。
- 设计与接口：
  - `settings.panelAutoShowDelayMs: number`；默认 3600000；`TriggerButtons` 使用该值。
- 触点与文件：
  - `src/views/app/components/TriggerButtons.vue`、`src/views/app/hook.ts`
- 实施步骤：
  - 将固定常量替换为设置值；持久化随域名隔离；UI 允许编辑。
- 验收标准：
  - 设置不同时长后符合预期恢复显示。

### 功能点：活跃样式强化（active 样式统一注入与可配置）
- 目标：突出当前命中项，提高可视性。
- 设计与接口：
  - 在 `generateHighlightStyle` 统一生成 `.highlight-active{ ... }`；允许在配置中设置边框、阴影、动画。
- 触点与文件：
  - `src/util/util.ts`（样式生成）、`src/views/app/components/ConfigDialog.vue`（配置项）
- 实施步骤：
  - 扩展样式生成；预览与保存；与高亮器类名对齐。
- 验收标准：
  - 导航切换时 active 明显；不同主题预设下可预览与保存。

### 功能点：滚动定位优化（边距与动画时长可调）
- 目标：避免贴边遮挡，滚动更自然。
- 设计与接口：
  - `settings.scroll`: `{ margin: number; durationMs: number }`；传入高亮器初始化。
- 触点与文件：
  - `src/util/tools.ts`（`initHighlighter` 参数）、`src/views/app/config.ts`（新增配置项）
- 实施步骤：
  - 扩展初始化参数与默认值；在 UI 编辑并预览；持久化。
- 验收标准：
  - 不同设置下滚动位置与动画符合预期。

## 阶段三：性能增强

### 功能点：分块/批处理扫描
- 目标：避免主线程长时间阻塞，平滑处理大型页面。
- 设计与接口：
  - 扫描任务拆分为小批次；空闲或定时片执行（`requestIdleCallback`/`setTimeout`）；提供进度状态与取消。
- 触点与文件：
  - `src/util/tools.ts`（`apply` 与遍历）、`src/views/app/hook.ts`（状态展示）
- 实施步骤：
  - 抽象任务队列；分批处理文本节点；在调试面板展示耗时与批次统计。
- 验收标准：
  - 大页面下交互不卡顿；统计信息显示批量效果与总耗时降低。

### 功能点：增量高亮（MutationObserver）
- 目标：观察新增 DOM，增量处理避免全量重扫。
- 设计与接口：
  - 在启用后建立观察器；仅处理新增文本节点；清除时完全断开并释放引用。
- 触点与文件：
  - `src/views/app/hook.ts`（生命周期与清理）、`src/util/tools.ts`（增量 `apply`）
- 实施步骤：
  - 封装观察器管理；与队列协同；调试面板记录变更与增量命中。
- 验收标准：
  - 动态内容加载后即时高亮；清除与卸载无内存泄漏。

### 功能点：节点过滤与缓存
- 目标：跳过大型容器或重复内容，降低开销。
- 设计与接口：
  - 选择器/长度阈值过滤；WeakMap 记录已处理节点哈希。
- 触点与文件：
  - `src/util/tools.ts`（节点过滤与缓存）、`src/views/app/config.ts`（新增配置项）
- 实施步骤：
  - 过滤规则与缓存实现；调试面板显示命中/跳过统计。
- 验收标准：
  - 性能基准显示扫描时间降低；功能正确。

### 功能点：异步队列（可取消，导航优先）
- 目标：统一管理高亮任务与导航，提升响应性。
- 设计与接口：
  - 任务类型：`scan`/`incremental`/`navigate`；优先级：`navigate > incremental > scan`；支持取消。
- 触点与文件：
  - `src/util/tools.ts`（内部队列）、`src/views/app/hook.ts`（状态与控制）
- 实施步骤：
  - 队列调度器；互斥与优先级；可视化进度。
- 验收标准：
  - 导航操作即时响应；长任务可取消；无死锁。

## 阶段四：扩展功能

### 功能点：关键词分组样式（组内导航）
- 目标：不同分组应用独立主题色与导航。
- 设计与接口：
  - 规则支持 `groups: { name: string; keywords: string[]; theme?: string }[]`；样式生成按组输出；导航支持按组跳转。
- 触点与文件：
  - `src/views/app/config.ts`（结构与预设）、`src/util/util.ts`（样式生成）、`src/views/app/components/NavigationPanel.vue`（UI）
- 实施步骤：
  - 扩展数据结构；按组生成 CSS；导航面板按组计数与跳转；调试面板显示分组分布。
- 验收标准：
  - 多组并存样式正确；组内上一/下一可用；统计按组准确。

### 功能点：临时搜索（不写入规则）
- 目标：用户输入一次性关键词进行试用。
- 设计与接口：
  - 在导航面板提供输入框与“临时启用”按钮；仅本次会话生效，清除即移除。
- 触点与文件：
  - `src/views/app/components/NavigationPanel.vue`、`src/views/app/hook.ts`
- 实施步骤：
  - 独立状态存储与高亮触发；不影响持久化配置。
- 验收标准：
  - 临时关键词高亮与导航正常；刷新后不保留。

### 功能点：定位历史与列表
- 目标：列出所有命中位置，支持点击跳转与历史回退。
- 设计与接口：
  - 记录命中索引列表与历史栈；列表 UI 可筛选与跳转；历史回退按栈返回。
- 触点与文件：
  - `src/views/app/components/NavigationPanel.vue`、`src/views/app/hook.ts`
- 实施步骤：
  - 同步高亮器索引与列表；支持点击跳转；维护回退栈。
- 验收标准：
  - 列表数与当前命中一致；回退逻辑正确。

### 功能点：高亮统计与导出（CSV）
- 目标：统计命中数量与分组分布，导出 CSV。
- 设计与接口：
  - 统计结构 `{ total, byGroup: Record<string, number> }`；导出使用 `GM_setClipboard`。
- 触点与文件：
  - `src/views/app/components/DebugDialog.vue`、`src/views/app/hook.ts`
- 实施步骤：
  - 统计生成与展示；点击导出复制到剪贴板。
- 验收标准：
  - 统计正确；CSV 内容结构化。

### 功能点：选区内高亮
- 目标：仅在用户选中的范围内应用高亮，便于局部检索。
- 设计与接口：
  - 获取选区容器（父节点或 Range 包含块）；将容器传入 `initHighlighter`/`highlightKeywords`。
- 触点与文件：
  - `src/views/app/hook.ts`（选区获取）、`src/util/tools.ts`（容器参数）
- 实施步骤：
  - 选区解析与容器校验；UI 提供“仅选区”开关；清除时复位。
- 验收标准：
  - 仅选区命中；跨选区不影响其它区域。

## 工程与测试
- 单元测试：匹配逻辑、样式生成、增量高亮（模拟 DOM）；新增本地测试目录（不打包）。
- 性能基准：构建“大文档”基准页，量化时间/内存与优化收益；调试面板展示指标。
- 错误监控：调试面板结构化展示错误与耗时，支持导出 JSON。
- 构建体积与 CDN：保持外部化，提示网络失败的回退说明（不内置）。

## 清理与内存管理
- 观察器、快捷键、队列、缓存等在清除高亮与脚本卸载时必须完整释放；遵循当前 `handleClearHighlight` 与 `onUnmounted` 清理流程。

## 交付物
- 每阶段完成后：功能演示、配置示例、调试面板指标截图（或数值）、简短变更说明（不增加打包体积）。
